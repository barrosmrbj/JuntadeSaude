<!-- pages/Consulta.html -->


<header class="titulo-centro">
  <h1>JUNTA DE SA√öDE - AppWeb Vers√£o 1.0</h1>
</header>

<!-- Campo CPF -->
<div class="linha-campo linha-campo-cpf">
  <label for="CampoCPF">CPF (somente n√∫meros) - do INSPECIONANDO</label>
  <input id="CampoCPF"
         type="text"
         maxlength="11"
         placeholder="00000000000"
         oninput="calcularCPF(this)">
  <div class="error-message" id="CampoCPF-error"></div>
</div>

<!-- Bot√µes iniciais -->
<div class="area-botoes">
  <button id="btnlimpar">LIMPAR</button>
  <button id="btnpesquisar">PESQUISAR</button>
</div>

<div id="statusMsg" style="margin-top:20px; text-align:center; font-style:italic; color:#444; display:none;"></div>

<!-- Container do wizard (inicialmente escondido) -->
<div id="wizardContainer" style="display:none; margin-top:10px;">
  <!-- abas / passos -->
    <div id="wizardSteps" class="wizard-steps-container">
          <div id="stepIndicators" class="step-indicators">

              <div class="step-item" id="step1-ind">
                  <div class="step-circle">1</div>
                  <span class="step-label">Dados</span>
              </div>

              <div class="step-line"></div>

              <div class="step-item" id="step2-ind">
                  <div class="step-circle">2</div>
                  <span class="step-label">GP / Final</span>
              </div>

              <div class="step-line"></div>

              <div class="step-item" id="step3-ind">
                  <div class="step-circle">3</div>
                  <span class="step-label">JSS</span>
              </div>

              <div class="step-line"></div>

              <div class="step-item" id="step4-ind">
                  <div class="step-circle">4</div>
                  <span class="step-label">Curso</span>
              </div>

              <div class="step-line"></div>

              <div class="step-item" id="step5-ind">
                  <div class="step-circle">5</div>
                  <span class="step-label">Concluir</span>
              </div>

          </div>
    </div>

      <!-- STEP 1 - DADOS (visualiza√ß√£o dos dados retornados) -->
      <div id="step-1" class="wizard-step">
        <div id="resultadoConsulta"></div>
        <div class="wizard-buttons">
          <button class="btn-sistema btn-voltar" id="btnEdicao">Editar Cadastro</button>
          <button class="btn-sistema btn-secundario" id="toStep2">Continuar</button>
        </div>
      </div>

      <!-- STEP 2 - GP/FINAL -->
      <div id="step-2" class="wizard-step" style="display:none;">
        <div class="resultado-card">
          <h3>Grupo e Finalidade</h3>

          <div class="grupo-container">
              <label><strong>Grupo (selecione 1)</strong></label>
              <select id="selectGrupo">
                <option value="">-- selecione --</option>
              </select>
          </div>

          <!-- BADGES DAS FINALIDADES SELECIONADAS -->
          <div id="finalidadesSelecionadasBox" 
              style="margin: 10px 0; display:flex; gap:8px; flex-wrap:wrap;">
          </div>

          <div style="margin-top:10px;">
            <label><strong>Finalidade (m√°x. 3)</strong></label>
            <div id="finalidadeList" style="margin-top:6px; max-height:220px; overflow:auto;"></div>
          </div>

        </div>

        <div class="wizard-buttons">
          <button class="btn-sistema btn-secundario" id="prevTo1">Anterior</button>
          <button class="btn-sistema" id="toStep3" >Pr√≥ximo</button>
        </div>
      </div>

      <!-- STEP 3 - JSS -->
      <div id="step-3" class="wizard-step" style="display:none;">
        <div class="resultado-card">
          <h3>JSS ‚Äî Dados de Restri√ß√£o Cl√≠nica</h3>

          <div class="linha-campo">
            <label for="clinica_restricao">Cl√≠nica Restri√ß√£o</label>
            <input id="clinica_restricao" type="text" placeholder="Nome da cl√≠nica">
          </div>

          <div class="linha-campo">
            <label for="data_inicio_restricao">Data In√≠cio Restri√ß√£o</label>
            <input id="data_inicio_restricao" type="date">
          </div>

        </div>

        <div class="wizard-buttons">
          <button class="btn-sistema btn-secundario" id="prevTo2">Anterior</button>
          <button class="btn-sistema" id="toStep4-possible" >Pr√≥ximo</button>
        </div>
      </div>

      <!-- STEP 4 - CURSO -->
      <div id="step-4" class="wizard-step" style="display:none;">
        <div class="resultado-card">
          <h3>Curso ‚Äî Dados do Curso</h3>

          <div class="linha-campo">
            <label for="descricao_curso">Descri√ß√£o do Curso</label>
            <input id="descricao_curso" type="text" placeholder="Nome do Curso">
          </div>

          <div class="linha-campo">
            <label for="periodo_curso">Per√≠odo do Curso</label>
            <input id="periodo_curso" type="text" placeholder="Ex: 01/2025 - 06/2025">
          </div>

        </div>

        <div class="wizard-buttons">
          <button class="btn-sistema btn-secundario" id="prevTo3">Anterior</button>
          <button class="btn-sistema" id="toStep5">Pr√≥ximo</button>
        </div>
      </div>

      <!-- STEP 5 - CONCLUIR -->
      <div id="step-5" class="wizard-step" style="display:none;">
        <div class="resultado-card">
          <h3>Se√ß√£o de Consentimento</h3>

          <div style="margin-bottom:10px;">
              <p>
                  Ao prosseguir para o preenchimento, o(a) inspecionando(a)/usu√°rio(a):
                  <ul class="lista-consentimento"> <li>Declara estar plenamente ciente do prop√≥sito desta coleta de dados.</li>
                      <li>Autoriza o tratamento dos seus dados pelo HAMN exclusivamente para as finalidades descritas.</li>
                      <li>Compromete-se a utilizar este formul√°rio de forma √©tica e verdadeira.</li>
                  </ul>
              </p>
          </div>

          <div class="linha-campo">
            <label>
              <input type="checkbox" id="consentCheckbox"> Eu concordo com as condi√ß√µes descritas
            </label>
          </div>

          <div class="wizard-buttons">
            <button class="btn-sistema btn-secundario" id="prevTo4">Anterior</button>
            <button class="btn-sistema" id="btnSalvarFinal" disabled >Salvar ‚úî</button>
          </div>

        </div>
      </div>


</div>


<script>

/* =====================================================================
   Fun√ß√£o executada quando essa subp√°gina √© carregada pelo SPA
   ===================================================================== */
window.__VIEW_REGISTRY = window.__VIEW_REGISTRY || {};

window.__VIEW_REGISTRY['Consulta'] = function(exports, APP, Store){
  console.log("window.__VIEW_REGISTRY[Consulta]");

  function bind() {
          // DOM bindings: use IDs existentes
          // liga bot√µes iniciais
          document.getElementById("btnlimpar").onclick = limparCampos;
          document.getElementById("btnpesquisar").onclick = onPesquisarClick;

          // navega√ß√£o do wizard
          document.getElementById("toStep2").onclick = () => goToStep(2);
          document.getElementById("prevTo1").onclick = () => goToStep(1);
          document.getElementById("toStep3").onclick = () => goToStep(3);
          document.getElementById("prevTo2").onclick = () => goToStep(2);
          document.getElementById("toStep4-possible").onclick = () => goToStep(4);
          document.getElementById("prevTo3").onclick = () => goToStep(3);
          document.getElementById("toStep5").onclick = () => goToStep(5);
          document.getElementById("prevTo4").onclick = () => {
            const prev = getPreviousStep();
            goToStep(prev);
          };


          document.getElementById("btnSalvarFinal").onclick = SalvarTudo;
          document.getElementById("btnEdicao").onclick = toEdicao;

          // consent checkbox
          const cb = document.getElementById("consentCheckbox");
          cb.onchange = () => {
            document.getElementById("btnSalvarFinal").disabled = !cb.checked;
          };
  }

  function unbind() {
    // remover listeners adicionados manualmente
    //document.getElementById("btnlimpar").onclick = null;
    // 1. Obtenha a refer√™ncia do elemento
    const btnPesquisar = document.getElementById("btnPesquisar"); 
    const btnlimpar = document.getElementById("btnlimpar"); 

    // 2. Verifique se o elemento ainda existe antes de manipul√°-lo
    if (btnPesquisar) {
        btnPesquisar.onclick = null;
    }
    if (btnlimpar) {
        btnlimpar.onclick = null;
    }
  }

  function init(){
    bind();
    // inicialmente esconder wizard
    hideWizard();

  }

  // inicia
  init();

  // retornar um objeto com cleanup (router chamar√° cleanup quando mudar de view)
  return { cleanup: unbind};

};

/* =====================================================================
   LIMPAR CAMPOS e esconder wizard
   ===================================================================== */
function limparCampos() {
  document.getElementById("CampoCPF").value = "";
  document.getElementById("CampoCPF-error").innerText = "";
  document.getElementById("resultadoConsulta").innerHTML = "";

  document.getElementById("edicaoDados") && (document.getElementById("edicaoDados").innerHTML = "");
  document.getElementById("statusMsg").style.display = "none";

  // Resetar bot√µes do Step 1 para o padr√£o
  const btnEdicao = document.getElementById("btnEdicao");
  const btnContinuar = document.getElementById("toStep2");
  
  if(btnEdicao) btnEdicao.innerText = "Editar Cadastro";
  if(btnContinuar) btnContinuar.style.display = "inline-block";

  hide_Nav_Cadastro();
  hideWizard();
  resetarAplicacao();
  toast("Campos limpos.", "green");
}

function toEdicao() {
    mostrarCarregando();
    if (!CURRENT_DATA || !CURRENT_DATA.cpf) {
        toast("Nenhum dado v√°lido para editar. Fa√ßa uma pesquisa primeiro.", "red");
        return;
    }

    // 1. Armazena os dados encontrados na Store para a pr√≥xima tela
    Store.set("dadosEdicao", CURRENT_DATA);
    
    // 2. Define o modo: EDITAR
    Store.set("modoCadastro", "EDITAR"); 
    
    // 3. Vai para a tela de Cadastro/Edi√ß√£o
    go("Cadastro");
}

/* =====================================================================
   Quando clicar PESQUISAR
   ===================================================================== */
function onPesquisarClick() {

  hideWizard();// Oculta o "wizard" (se estiver vis√≠vel)

  const input = document.getElementById("CampoCPF");
  if (!calcularCPF(input)) { toast("CPF inv√°lido.", "red"); return;}

  const cpf = input.value;

  goToStep(1);   // <-- SEMPRE vai volta p/ etapa 1 depois da pesquisa

  // Mostrar mensagem de pesquisa ANTES de esconder/mostrar steps
  let status = document.getElementById("statusMsg");
  status.style.display = "flex";
  status.style.justifyContent = "center";
  status.style.alignItems = "center";
  status.style.textAlign = "center";
  status.style.marginTop = "25px";
  status.innerHTML =   `<div style="display:flex;align-items:center;gap:10px;font-size:16px;">
                        <div class="spinner"></div> Pesquisando...
                        </div>`;

  // Desabilita e centraliza o campo CPF ap√≥s pesquisar
  const campo = document.getElementById("CampoCPF");
  campo.disabled = true;
  campo.classList.add("input-desabilitado");

  mostrarCarregando("Pesquisando dados, aguarde..."); // <-- LIGA O BLOQUEIO

  //Chamada ao Google Apps Script - GAS
  google.script.run
    .withSuccessHandler(res => {
      esconderCarregando(); // <-- DESLIGA O BLOQUEIO
      console.log("Resposta GAS pesquisa:", res);
      if (!res || !res.success) {
        // Verifica se o inspecionando n√£o foi encontrado
        if (!res || res.success === false) {
          // Exibe o modal com os bot√µes de Cancelar e Cadastrar
          show_Nav_Cadastro();
          console.log("CPF:   " +cpf);
          abrirModalCadastro(cpf);  // Passa o CPF para o modal
        } else {
          document.getElementById("resultadoConsulta").innerHTML = `<div style="color:red;">${res.message || 'Erro desconhecido'}</div>`;
        }
        return;
      }
      CURRENT_DATA = res.data || {};
      showWizardWithData(CURRENT_DATA); // Abre o wizard com os dados encontrados
    })
    .withFailureHandler(err => {
      esconderCarregando(); // <-- DESLIGA O BLOQUEIO
      console.error("Erro na chamada GAS:", err);
      document.getElementById("resultadoConsulta").innerHTML = `<div style="color:red;">Erro: ${err.message}</div>`;
    })
    .PesquisarDadosARQUIVO(cpf);  // Passa o CPF para a pesquisa no Google Apps Script
}

/* Fun√ß√£o para abrir o modal de Cadastro */
function abrirModalCadastro(cpf) {
  // Criando o HTML do modal
  Store.set("cpfCadastro", cpf);
  const modalHTML = `
    <div class="modal-overlay" id="modalCadastro">
      <div class="modal-content">
        <h3>Inspecionando N√ÉO encontrado</h3>
        <p>O inspecionando com CPF ${cpf} n√£o foi encontrado. Voc√™ deseja cadastrar?</p>
        <div class="modal-buttons">
          <button id="btnCancelar" onclick="fecharModalCadastro()">Cancelar</button>
          <button id="btnCadastrar" onclick="irParaCadastro('${cpf}')">Cadastrar</button>
        </div>
      </div>
    </div>
  `;

  // Adiciona o modal ao corpo da p√°gina
  document.body.insertAdjacentHTML('beforeend', modalHTML);

  // Exibe o modal
  document.getElementById("modalCadastro").style.display = "flex";
}

/* Fun√ß√£o para fechar o modal */
function fecharModalCadastro() {
  
  const modal = document.getElementById("modalCadastro");
  if (modal) {
    modal.style.display = "none";
    modal.remove();  // Remove o modal do DOM
  }
}

/* Fun√ß√£o para redirecionar para a tela de cadastro */
function irParaCadastro(cpf) {
  // Fecha o modal
  fecharModalCadastro();

  // Preenche o CPF no objeto exports, que ser√° utilizado na p√°gina de Cadastro
  Store.set("cpfCadastro", cpf)
  // habilita menu Cadastro
  const btn = document.getElementById("btnNav_Cadastro");
  if (btn) btn.style.display = "inline-block";

  console.log("go('Cadastro')");

  go("Cadastro");

}

/* =====================================================================
   Mostrar Wizard e preencher Etapa 1 com os dados
   ===================================================================== */
function showWizardWithData(data) {
  // Ocultar o spinner
  document.getElementById("statusMsg").style.display = "none";

  // garante que CURRENT_DATA esteja atualizado
  CURRENT_DATA = data || {};

  document.getElementById("wizardContainer").style.display = "block";
  CURRENT_STEP = 1;
  updateStepIndicators();

  // Renderiza os dados no Step 1
  renderStep1(CURRENT_DATA);

  // --- L√ìGICA DE VALIDA√á√ÉO DO COD ---
  const btnEdicao = document.getElementById("btnEdicao");
  const btnContinuar = document.getElementById("toStep2");

  // Verifica se r.cod √© nulo, undefined ou string vazia
  if (!CURRENT_DATA.cod || CURRENT_DATA.cod.toString().trim() === "") {
    // 1. Muda nome do bot√£o
    btnEdicao.innerText = "Atualizar Cadastro";
    // 2. Garante que ele esteja vis√≠vel/habilitado (estilo padr√£o)
    btnEdicao.style.display = "inline-block"; 
    // 3. Oculta o bot√£o Continuar
    btnContinuar.style.display = "none";
    
    toast("Cadastro incompleto. Por favor, atualize os dados.", "orange");
  } else {
    // Caso tenha COD, volta ao estado normal
    btnEdicao.innerText = "Editar Cadastro";
    btnEdicao.style.display = "inline-block";
    btnContinuar.style.display = "inline-block";
  }
  // ----------------------------------

  // Restante da sua l√≥gica original
  selectedFinalidades = new Set();
  renderGroupOptions();
  renderFinalidadesOptions();
  checkConditionalSteps();

  document.getElementById("wizardContainer").style.opacity = "1";
}

/* =====================================================================
   Esconder wizard
   ===================================================================== */
function hideWizard() {
  document.getElementById("wizardContainer").style.display = "none";
  CURRENT_STEP = 1;
  updateStepIndicators();
}

/* =====================================================================
   Renderizar Step 1 (dados)
   ===================================================================== */
function renderStep1(r) {
  const out = document.getElementById("resultadoConsulta");

  if (!r) {
    out.innerHTML = `<div style="color:red;">Nenhum dado para exibir.</div>`;
    return;
  }

  const html = `
    <div class="resultado-card">
      <h3>Dados Encontrados</h3>
      <strong>COD-ARQV:</strong> ${r.cod || ''} / ${r.arqv || ''}<br>
      <strong>Nome:</strong> ${r.nome || ''}<br>
      <strong>CPF:</strong> ${r.cpf || ''}              <strong>SARAM:</strong> ${r.saram || ''}<br>
      <strong>RG/√ìrg√£o:</strong> ${r.rg || ''} ${r.orgao || ''}<br>
      <strong>Data Nascimento:</strong> ${r.nascimento || ''} <strong>Naturalidade:</strong> ${r.naturalidade || ''}<br>
      <strong>Sexo:</strong> ${r.sexo || ''}<br>
      <strong>Posto/Quadro/Esp:</strong> ${r.posto || ''} ${r.quadro || ''} ${r.especialidade || ''}<br>
      <strong>OM:</strong> ${r.om || ''}<br>
      <strong>Email:</strong> ${r.email || ''} <strong>Tipo Sanguineo:</strong> ${r.tp_sang || ''}<br>
      <strong>Telefone:</strong> ${r.telefone || ''}<br>
      <strong>Endere√ßo:</strong> ${r.endereco || ''}<br>
      <strong>V√≠nculo:</strong> ${r.vinculo || ''}<br>
      <strong>Grupo atual:</strong> ${r.grupo || ''}<br>
    </div>
  `;
  out.innerHTML = html;
}

/* =====================================================================
   Renderizar op√ß√µes de Grupo (step 2)
   ===================================================================== */
function renderGroupOptions() {
  const sel = document.getElementById("selectGrupo");
  if (!sel) return;

  // limpa e adiciona op√ß√£o padr√£o
  sel.innerHTML = `<option value="">-- selecione --</option>`;

  if (!window.APP || !Array.isArray(APP.GRUPOS_LIST)) {
    console.warn("APP.GRUPOS_LIST vazio ou APP n√£o dispon√≠vel.");
    return;
  }

  // popular op√ß√µes
  APP.GRUPOS_LIST.forEach(g => {
    const opt = document.createElement("option");
    opt.value = g;
    opt.textContent = g;
    sel.appendChild(opt);
  });

  // tentar pr√©-selecionar com base em CURRENT_DATA.grupo, apenas se houver correspond√™ncia
  if (CURRENT_DATA && CURRENT_DATA.grupo) {
    const wanted = CURRENT_DATA.grupo.toString().trim();
    if (wanted !== "") {
      // procurar op√ß√£o existente (case-insensitive, trim)
      const opcao = Array.from(sel.options).find(o => {
        return o.value.toString().trim().toLowerCase() === wanted.toLowerCase();
      });

      if (opcao) {
        sel.value = opcao.value;
        console.log("Grupo pr√©-selecionado:", opcao.value);
      } else {
        // n√£o existe ‚Äî n√£o seleciona nada
        sel.value = "";
        console.warn("Grupo retornado n√£o encontrado na lista:", wanted);
      }
    }
  }
}


/* =====================================================================
   Renderizar op√ß√µes de Finalidades (checkbox list) (step 2)
   ===================================================================== */

function renderFinalidadesOptions() {
  console.log("üîÑ renderFinalidadesOptions() iniciado");
  
  const div = document.getElementById("finalidadeList");
  if (!div) {
    console.warn("‚ùå finalidades DIV n√£o encontrada!");
    return;
  }

  div.innerHTML = ""; // limpar lista

  if (!window.APP || !Array.isArray(APP.FINALIDADES_LIST)) {
    console.warn("‚ùå APP.FINALIDADES_LIST vazio ou inv√°lido:", APP.FINALIDADES_LIST);
    return;
  }

  // reset antes de popular
  selectedFinalidades = new Set();

  console.log("üìå CURRENT_DATA.finalidade =", CURRENT_DATA?.finalidade);

  APP.FINALIDADES_LIST.forEach(fin => {
    const id = "fin_" + fin.replace(/\s+/g, "_");

    const wrapper = document.createElement("div");
    wrapper.className = "finalidade-item";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.id = id;
    cb.value = fin;

    const lbl = document.createElement("label");
    lbl.htmlFor = id;
    lbl.textContent = fin;

    wrapper.appendChild(cb);
    wrapper.appendChild(lbl);
    div.appendChild(wrapper);

    /* ---------------------------
       PR√â-SELE√á√ÉO PELO CPF buscado
       --------------------------- */
    if (CURRENT_DATA && CURRENT_DATA.finalidade) {
      let finals = CURRENT_DATA.finalidade;

      if (!Array.isArray(finals)) finals = [finals];

      finals = finals.map(f => f.toString().trim().toLowerCase());

      if (finals.includes(fin.toString().trim().toLowerCase())) {
        cb.checked = true;
        selectedFinalidades.add(fin);
        console.log(`‚úî Pr√©-selecionada: "${fin}"`);
      }
    }

    /* ---------------------------
       Handler: limite de 3
       --------------------------- */
    cb.addEventListener("change", () => {

      if (cb.checked) {
        if (selectedFinalidades.size >= 3) {
          cb.checked = false;
          console.log(`‚ùå Tentou selecionar mais de 3. Ignorado: ${fin}`);
          toast("Voc√™ pode selecionar no m√°ximo 3 finalidades.", "red");
          return;
        }
        selectedFinalidades.add(fin);
        console.log(`üü¢ Selecionada: ${fin}`);
      } else {
        selectedFinalidades.delete(fin);
        console.log(`üî¥ Removida: ${fin}`);
      }

      atualizarFinalidadesSelecionadas();
      console.log("üìå Finalidades atuais:", Array.from(selectedFinalidades));
      checkConditionalSteps();
    });
  });

  console.log("üìå Finalidades pr√©-selecionadas no carregamento:", Array.from(selectedFinalidades));

  checkConditionalSteps(); // garantir estado inicial correto

  console.log("‚úÖ renderFinalidadesOptions() finalizado");
}



/* =====================================================================
   Manipula√ß√£o das finalidades (m√°x 3)
   ===================================================================== */
function onFinalidadeChange(e) {
  const cb = e.target;
  const val = cb.value;

  if (cb.checked) {
    if (selectedFinalidades.size >= 3) {
      cb.checked = false;
      toast("M√°ximo de 3 finalidades permitidas.", "red");
      return;
    }
    selectedFinalidades.add(val);
  } else {
    selectedFinalidades.delete(val);
  }

  applyFinalidadesRules();
}

/* =====================================================================
   Aplica regras para habilitar JSS / CURSO e controlar limites
   ===================================================================== */
function applyFinalidadesRules() {
  // Habilitar JSS se alguma finalidade come√ßa com "G"
  const anyG = Array.from(selectedFinalidades).some(f => f && f.trim().charAt(0).toUpperCase() === "G");
  // Habilitar CURSO se alguma finalidade come√ßa com "I"
  const anyI = Array.from(selectedFinalidades).some(f => f && f.trim().charAt(0).toUpperCase() === "I");

  // Mostrar/ocultar abas 3 e 4 visualmente (explicitar ao usu√°rio)
  const ind3 = document.getElementById("step3-ind");
  if (ind3) ind3.style.opacity = anyG ? "1" : "0.4";

  const ind4 = document.getElementById("step4-ind");
  if (ind4) ind4.style.opacity = anyI ? "1" : "0.4";

  // Ajustar navega√ß√£o: se user tentar ir para passo 3/4 sem habilitar, bloqueia no goToStep

  // Se selecionadas vazias e CURRENT_DATA indica finalidades atuais,
  // n√£o for√ßar sele√ß√£o aqui ‚Äî o usu√°rio escolhe
}

/* =====================================================================
   Verifica se as abas condicionais devem existir (baseado nas listas)
   ===================================================================== */
function checkConditionalSteps() {
  // redefine para permitir navega√ß√£o condicional
  // (navega√ß√£o de fato √© proibida no goToStep quando condi√ß√£o n√£o satisfeita)
  applyFinalidadesRules();
}

/* =====================================================================
   Navega√ß√£o entre steps com valida√ß√£o
   ===================================================================== */
function goToStep(n) {

  // Validar antes de avan√ßar
  if (n === 2) {
    if (!CURRENT_DATA) { 
      toast("Pesquise antes de continuar.", "red"); 
      return; 
    }
  }

  // Regras para finalidades
  const anyG = Array.from(selectedFinalidades).some(f => f.trim().charAt(0).toUpperCase() === "G");
  const anyI = Array.from(selectedFinalidades).some(f => f.trim().charAt(0).toUpperCase() === "I");

  /* ==========================================================
      L√ìGICA ESPECIAL DOS SALTOS
     ========================================================== */

  // Indo da etapa 2 para a pr√≥xima
  if (CURRENT_STEP === 2 && n === 3) {

    if (anyG) {
      // ir para JSS (step 3)
      n = 3;
    } else if (anyI) {
      // pular JSS e ir direto para CURSO
      n = 4;
    } else {
      // pular JSS e CURSO ‚Üí ir para CONCLUIR
      n = 5;
    }
  }

  // Indo da etapa 3 ‚Üí pr√≥xima
  if (CURRENT_STEP === 3 && n === 4) {
    if (anyI) {
      n = 4;  // curso habilitado
    } else {
      n = 5;  // sem I ‚Üí pular para concluir
    }
  }

  // Indo da etapa 4 ‚Üí sempre vai para concluir
  if (CURRENT_STEP === 4 && n === 5) {
    // ok
  }

  // Travar caso tente ir ao step 3 sem G
  if (n === 3 && !anyG) {
    toast("Aba JSS s√≥ habilitada se houver finalidade que comece com 'G'.", "red");
    return;
  }

  // Travar caso tente ir ao step 4 sem I
  if (n === 4 && !anyI) {
    toast("Aba CURSO s√≥ habilitada se houver finalidade que comece com 'I'.", "red");
    return;
  }

  // Exige ao menos 1 finalidade para concluir
  if (n === 5 && selectedFinalidades.size === 0) {
    toast("Selecione ao menos uma finalidade antes de concluir.", "red");
    return;
  }

  /* ==========================================================
      EXIBIR O STEP CORRETAMENTE
     ========================================================== */
  for (let i = 1; i <= 5; i++) {
    const stepEl = document.getElementById("step-" + i);
    if (stepEl) {
        if (i === n) {
            stepEl.classList.add("active-step");
        } else {
            stepEl.classList.remove("active-step");
        }
    }


    const ind = document.getElementById("step" + i + "-ind");
    if (ind) {
      if (i === n) ind.classList.add("active");
      else ind.classList.remove("active");
    }
  }

  CURRENT_STEP = n;
  updateStepIndicators();
}

function getPreviousStep() {
  // sempre pode voltar da 5 para 4 ou 3 ou 2
  const anyG = Array.from(selectedFinalidades)
        .some(f => f && f.trim().charAt(0).toUpperCase() === "G");

  const anyI = Array.from(selectedFinalidades)
        .some(f => f && f.trim().charAt(0).toUpperCase() === "I");

  // Se houver finalidade "I" ‚Üí etapa 4 existe
  if (anyI) return 4;

  // Se houver finalidade "G" ‚Üí etapa 3 existe
  if (anyG) return 3;

  // Se n√£o tem G nem I ‚Üí volta direto para etapa 2
  return 2;
}


/* =====================================================================
   Atualiza indicadores visuais de passo (pode ser aprimorado)
   ===================================================================== */
function updateStepIndicators() {
    for (let i = 1; i <= 5; i++) {
        const item = document.getElementById(`step${i}-ind`);
        const lineBefore = document.querySelector(`#step${i}-ind + .step-line`);

        item.classList.remove("active", "completed");
        if (lineBefore) lineBefore.classList.remove("completed");

        if (i < CURRENT_STEP) {
            item.classList.add("completed");
            if (lineBefore) lineBefore.classList.add("completed");
        }
        else if (i === CURRENT_STEP) {
            item.classList.add("active");
        }
    }
}


/* =====================================================================
   Coleta todos os dados do wizard e envia ao GAS
   ===================================================================== */
function SalvarTudo() {

  mostrarCarregando("Salvando Ficha de Inspe√ß√£o..."); // <-- BLOQUEIA

  const payload = {
    // dados b√°sicos trazidos da pesquisa (CURRENT_DATA)
    dt_insp: new Date().toISOString(), // ser√° substitu√≠do no GAS pelo padr√£o BR
    cod: CURRENT_DATA?.cod || "",
    arqv: CURRENT_DATA?.arqv || "",
    rg: CURRENT_DATA?.rg || "",
    orgao: CURRENT_DATA?.orgao || "",
    dt_nascimento: CURRENT_DATA?.nascimento || "",
    naturalidade: CURRENT_DATA?.naturalidade || "",
    cpf: CURRENT_DATA?.cpf || document.getElementById("CampoCPF").value,
    sexo: CURRENT_DATA?.sexo || "",
    posto: CURRENT_DATA?.posto || "",
    quadro: CURRENT_DATA?.quadro || "",
    especialidade: CURRENT_DATA?.especialidade || "",
    nome: CURRENT_DATA?.nome || "",
    saram: CURRENT_DATA?.saram || "",
    om: CURRENT_DATA?.om || "",
    vinculo: CURRENT_DATA?.vinculo || "",
    dec_judicial: "",           //---------------------------- a ser implementada depois
    email: CURRENT_DATA?.email || "",
    endereco: CURRENT_DATA?.endereco || "",
    telefone: CURRENT_DATA?.telefone || "",
    tp_sang: CURRENT_DATA?.tp_sang || "",
    cor: CURRENT_DATA?.cor || "",
    nacionalidade: CURRENT_DATA?.nacionalidade || "",

    // dados coletados no Wizard
    grupo: document.getElementById("selectGrupo").value || "",
    finalidades: Array.from(selectedFinalidades),
    clinica_restricao: document.getElementById("clinica_restricao")?.value || "",
    data_inicio_restricao: document.getElementById("data_inicio_restricao")?.value || "",
    obs_dis: document.getElementById("descricao_curso")?.value || "",
    obs_cartao: document.getElementById("periodo_curso")?.value || ""
  };

  console.log("Payload a salvar:", payload);

  toast("Salvando dados...", "blue");

  google.script.run
      .withSuccessHandler(res => {
          esconderCarregando(); // <-- LIBERA  
          if (res.success) {
              abrirModalSistema(
                  "Ficha salva!",
                  "A ficha foi registrada com sucesso.",
                res.orientacao || "Voc√™ pode seguir para o roteiro de inspe√ß√£o.",
                () => {
                    go("Roteiro");  // <<<<<<<<<<<<<< REDIRECIONA PARA A NOVA ABA
                }
              );
          } else {
              abrirModalSistema(
                  "Erro ao salvar",
                  res.message || "Erro inesperado.",
                  res.orientacao || "Tente novamente."
              );
          }
      })
      .withFailureHandler(err => {
          esconderCarregando(); // <-- LIBERA
          abrirModalSistema(
              "Falha t√©cnica",
              err.message || err,
              "Tente novamente ou procure o suporte t√©cnico."
          );
      })
      .SalvarAlteracoesFicha(payload);
}

function atualizarFinalidadesSelecionadas() {
    const box = document.getElementById("finalidadesSelecionadasBox");
    box.innerHTML = ""; // limpa

    if (selectedFinalidades.size === 0) {
        box.innerHTML = `<span style="color:#777; font-size:13px;">
            Nenhuma finalidade selecionada.
        </span>`;
        return;
    }

    selectedFinalidades.forEach(fin => {
        const tag = document.createElement("span");
        tag.style.cssText = `
            background:#2980b9;
            color:white;
            padding:6px 12px;
            border-radius:14px;
            font-size:13px;
            display:flex;
            align-items:center;
            gap:6px;
            animation: fadeIn .3s ease;
        `;
        tag.innerHTML = `${fin} <strong style="cursor:pointer;">√ó</strong>`;

        // remover clicando no X
        tag.querySelector("strong").onclick = () => {
            selectedFinalidades.delete(fin);

            // desmarca o checkbox correspondente
            const chk = document.querySelector(
                "#finalidadeList input[value='" + fin + "']"
            );
            if (chk) chk.checked = false;

            atualizarFinalidadesSelecionadas();
            checkConditionalSteps();
        };

        box.appendChild(tag);
    });
}

document.getElementById("modalBtnOk").addEventListener("click", () => {
    fecharModalSistema();
    if (modalCallback) modalCallback();
});

</script>
